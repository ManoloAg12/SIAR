{% extends 'base.html' %}

{% block content %}

{% if is_raining %}
<div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-6 rounded-lg" role="alert">
    <div class="flex">
        <div class="py-1"><i class="ri-cloudy-2-fill text-2xl mr-3"></i></div>
        <div>
            <p class="font-bold">¡Alerta de Lluvia!</p>
            <p class="text-sm">El sistema ha detectado lluvia en su área. El riego automático y la aplicación de perfiles se han pausado temporalmente para ahorrar agua.</p>
        </div>
    </div>
</div>
{% endif %}

<div class="mb-8">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-3xl font-bold text-gray-900">Panel de Control</h2>
            <p class="text-gray-600 mt-1">Bienvenido a tu sistema de riego inteligente</p>
            <p id="status-bbdd-wrapper" class="text-sm text-gray-500 mt-1">
                Estado BBDD: {{ db_status }}
            </p> 
        </div>
        <div class="flex items-center space-x-3">
            <button id="btn-actualizar-dash" class="bg-primary text-white px-4 py-2 rounded-lg hover:opacity-90 transition-all whitespace-nowrap !rounded-button">
                <i class="ri-refresh-line mr-2"></i>Actualizar
            </button>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    
    <div id="status-sistema-card-wrapper" class="bg-white rounded-xl shadow-lg p-6 card-hover">
        {% if device_status == 'regando' %}
        <div class="flex items-center justify-between">
            <div><p class="text-sm font-medium text-gray-600">Estado del Sistema</p><p class="text-2xl font-bold text-blue-600 mt-1">Regando</p></div>
            <div class="w-12 h-12 flex items-center justify-center bg-blue-100 rounded-full status-active"><i class="ri-drop-line text-blue-600 text-2xl"></i></div>
        </div>
        {% elif device_status == 'online' %}
        <div class="flex items-center justify-between">
            <div><p class="text-sm font-medium text-gray-600">Estado del Sistema</p><p class="text-2xl font-bold text-green-600 mt-1">Conectado</p></div>
            <div class="w-12 h-12 flex items-center justify-center bg-green-100 rounded-full"><i class="ri-play-circle-fill text-green-600 text-2xl"></i></div>
        </div>
        {% else %}
        <div class="flex items-center justify-between">
            <div><p class="text-sm font-medium text-gray-600">Estado del Sistema</p><p class="text-2xl font-bold text-red-600 mt-1">Desconectado</p></div>
            <div class="w-12 h-12 flex items-center justify-center bg-red-100 rounded-full"><i class="ri-wifi-off-line text-red-600 text-2xl"></i></div>
        </div>
        {% endif %}
    </div>
    
    <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600">Humedad del Suelo</p>
                
                <p id="humidityValue" class="text-2xl font-bold text-blue-600 mt-1">--%</p>
                
            </div>
            <div class="w-12 h-12 flex items-center justify-center bg-blue-100 rounded-full">
                <i class="ri-drop-line text-blue-600 text-2xl"></i>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
        {% if weather %}
            <div class="flex items-center justify-between">
                <div><p class="text-sm font-medium text-gray-600">{{ weather.description }}</p><p class="text-2xl font-bold text-orange-600 mt-1">{{ weather.temp }}°C</p></div>
                <div class="w-12 h-12 flex items-center justify-center bg-orange-100 rounded-full"><img src="http://openweathermap.org/img/wn/{{ weather.icon }}.png" alt="clima"></div>
            </div>
        {% else %}
            <div class="flex items-center justify-between">
                <div><p class="text-sm font-medium text-gray-600">Clima</p><p class="text-lg font-bold text-gray-500 mt-1">No disponible</p></div>
                <div class="w-12 h-12 flex items-center justify-center bg-gray-100 rounded-full"><i class="ri-question-mark text-gray-500 text-2xl"></i></div>
            </div>
        {% endif %}
    </div>
    <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Consumo de Agua</p>
                    <p id="waterConsumptionValue" class="text-2xl font-bold text-indigo-600 mt-1">--L</p>
                </div>
                <div class="w-12 h-12 flex items-center justify-center bg-indigo-100 rounded-full">
                    <i class="ri-water-percent-line text-indigo-600 text-2xl"></i>
                </div>
            </div>
        </div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
    <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6"><div class="flex items-center justify-between mb-6"><h3 class="text-xl font-semibold text-gray-900">Consumo de Agua Semanal</h3></div><div id="waterChart" class="h-80"></div></div>
<div class="bg-white rounded-xl shadow-lg p-6">
    <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-semibold text-gray-900">Mis Dispositivos</h3>
        <button id="openDeviceModal" class="text-primary hover:text-primary/80 text-sm font-medium">
            + Nuevo Dispositivo
        </button>
    </div>

    <div class="space-y-4">
        
        {% if dispositivos %}
            {% for disp in dispositivos %}
            
            {% set esta_activo = (disp.estado_actual == 'online' or disp.estado_actual == 'regando') %}

            <div class="p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 flex items-center justify-center bg-blue-100 rounded-lg">
                            <i class="ri-hard-drive-2-line text-blue-600"></i>
                        </div>
                        <div>
                            <p class="font-medium text-gray-900">{{ disp.nombre_dispositivo }}</p>
                            <p id="device-status-text-{{ disp.id }}" class="text-sm text-gray-600">
                                Estado: {{ disp.estado_actual }}
                            </p>
                        </div>
                    </div>
                    
                    <div class="custom-switch device-toggle-switch {% if esta_activo %}active{% endif %}" 
                         data-device-id="{{ disp.id }}">
                    </div>
                </div>

                {% if disp.estado_actual == 'offline_manual' %}
                <div id="api-key-container-{{ disp.id }}" class="mt-4 p-3 bg-gray-200 rounded-lg flex items-center justify-between">
                    <div class="flex-1 overflow-hidden">
                        <p class="text-xs text-gray-600 font-medium">API KEY (Para el instalador):</p>
                        <p class="text-sm font-mono text-gray-800 truncate">
                            {{ disp.device_api_key }}
                        </p>
                    </div>
                    <button class="copy-api-key-btn bg-gray-600 text-white px-3 py-1 rounded-lg hover:bg-gray-700 ml-2" 
                            data-key="{{ disp.device_api_key }}">
                        <i class="ri-file-copy-line"></i>
                    </button>
                </div>
                {% endif %}
                
            </div>
            {% endfor %}
        {% else %}
            <p class="text-gray-500 text-center">No ha registrado ningún dispositivo.</p>
        {% endif %}
        
    </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    
<div id="programacion-automatica-wrapper" class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-xl font-semibold text-gray-900 mb-6">Programación Automática</h3>
        
        {% if configuracion_actual %}
            <div class="space-y-4">
                <div class="flex items-center justify-between p-4 border border-green-200 bg-green-50 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 flex items-center justify-center bg-green-100 rounded-full">
                            <i class="ri-plant-line text-green-600"></i>
                        </div>
                        <div>
                        <p class="font-medium text-gray-900">
                        Riego Inteligente 
                            <span id="modo-automatico-status">
                            {% if configuracion_actual.modo_automatico %}
                                (<b class="text-green-600">Activo</b>)
                            {% else %}
                                (<b class="text-red-600">Desactivado</b>)
                            {% endif %}
                            </span>
                        </p>
                            <p class="font-medium text-gray-900"><b class="text-primary">
                            {% if configuracion_actual.perfil_activo %}
                                {{ configuracion_actual.perfil_activo.nombre_perfil }}
                            {% else %}
                                (Personalizado)
                            {% endif %}
                        </b></p>
                            <p class="text-sm text-gray-600">
                                Umbral: <b>{{ configuracion_actual.umbral_humedad_minima }}%</b> | 
                                Duración: <b>{{ configuracion_actual.duracion_riego_segundos }}s</b> |
                                Frecuencia Mín: <b>{{ configuracion_actual.frecuencia_minima_horas }}h</b>
                            </p>
                        </div>
                    </div>
                    <div class="custom-switch {% if configuracion_actual.modo_automatico %}active{% endif %}" data-config="modo_automatico"></div>
                </div>
                </div>
        {% else %}
            <p class="text-sm text-gray-500 text-center">
                Aún no se ha configurado un dispositivo. 
                Vaya a "Perfiles de Riego" y <b>Aplique</b> uno para comenzar.
            </p>
        {% endif %}
    </div>

    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-xl font-semibold text-gray-900 mb-6">Actividad Reciente</h3>
        
        <div id="recentActivityContainer" class="space-y-4">
            </div>
        
    </div>
</div>

<div class="grid grid-cols-1 gap-8 mt-8">
    <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold text-gray-900">Perfiles de Riego</h3>
            <button id="openProfileModal" class="text-primary hover:text-primary/80 text-sm font-medium">
                + Nuevo Perfil
            </button>
        </div>
        
        <div class="space-y-4">
            {% if perfiles %}
                {% for perfil in perfiles %}
                {% if perfil.usuario_id == current_user_id %}
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-lg"><i class="ri-price-tag-3-line text-gray-600"></i></div>
                            <div>
                                <p class="font-medium text-gray-900">{{ perfil.nombre_perfil }} <span class="text-xs text-green-600">(Mi Perfil)</span></p>
                                <p class="text-sm text-gray-600">{{ perfil.descripcion or 'Sin descripción' }} (Umbral: {{ perfil.umbral_humedad }}% / Duración: {{ perfil.duracion_riego_seg }}s)</p>
                            </div>
                        </div>
                        <button class="apply-profile-btn bg-secondary text-white px-4 py-2 rounded-lg hover:opacity-90 !rounded-button" data-id="{{ perfil.id }}">Aplicar</button>
                    </div>
                {% else %}
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg bg-gray-50">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 flex items-center justify-center bg-gray-200 rounded-lg"><i class="ri-group-line text-gray-600"></i></div>
                            <div>
                                <p class="font-medium text-gray-900">{{ perfil.nombre_perfil }}</p>
                                <p class="text-sm text-gray-600">{{ perfil.descripcion or 'Sin descripción' }} (Umbral: {{ perfil.umbral_humedad }}% / Duración: {{ perfil.duracion_riego_seg }}s)</p>
                            </div>
                        </div>
                        <button class="apply-profile-btn bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 !rounded-button" data-id="{{ perfil.id }}">Aplicar</button>
                    </div>
                {% endif %}
                {% endfor %}
            {% else %}
                <p class="text-gray-500 text-center">No hay perfiles de riego creados. ¡Crea el primero!</p>
            {% endif %}
        </div>
    </div>
</div>

<div id="newProfileModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg mx-4">
        <div class="flex items-start justify-between mb-4">
            <h3 class="text-xl font-semibold text-gray-900">Crear Nuevo Perfil de Riego</h3>
            <button id="closeProfileModal" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
        </div>
        
        <form id="profileForm" class="space-y-4">
            <div>
                <label for="perfil_nombre" class="block text-sm font-medium text-gray-700">Nombre del Perfil</label>
                <input type="text" id="perfil_nombre" name="nombre_perfil" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
            </div>
            <div>
                <label for="perfil_descripcion" class="block text-sm font-medium text-gray-700">Descripción Breve</label>
                <textarea id="perfil_descripcion" name="descripcion" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label for="perfil_umbral" class="block text-sm font-medium text-gray-700">Umbral Humedad (%)</label>
                    <input type="number" id="perfil_umbral" name="umbral_humedad" placeholder="Ej: 30" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                </div>
                <div>
                    <label for="perfil_duracion" class="block text-sm font-medium text-gray-700">Duración Riego (seg)</label>
                    <input type="number" id="perfil_duracion" name="duracion_riego_seg" placeholder="Ej: 20" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                </div>
                <div>
                    <label for="perfil_frecuencia" class="block text-sm font-medium text-gray-700">Frecuencia Mín. (h)</label>
                    <input type="number" id="perfil_frecuencia" name="frecuencia_minima_horas" value="4" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                </div>
            </div>
            <div class="flex justify-end space-x-4 pt-4">
                <button type="button" id="cancelProfileModal" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">Cancelar</button>
                <button type="submit" class="px-5 py-2 bg-primary text-white rounded-lg hover:bg-primary/80 transition-colors">Guardar Perfil</button>
            </div>
        </form>
    </div>
</div>

<div id="newDeviceModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
        
        <div class="flex items-start justify-between mb-4">
            <h3 class="text-xl font-semibold text-gray-900">Añadir Nuevo Dispositivo</h3>
            <button id="closeDeviceModal" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
        </div>
        
        <form id="deviceForm" class="space-y-4">
            <div>
                <label for="device_nombre" class="block text-sm font-medium text-gray-700">Nombre del Dispositivo (ej: Huerto)</label>
                <input type="text" id="device_nombre" name="nombre_dispositivo" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
            </div>
            
            <div class="flex justify-end space-x-4 pt-4">
                <button type="button" id="cancelDeviceModal" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">
                    Cancelar
                </button>
                <button type="submit" class="px-5 py-2 bg-primary text-white rounded-lg hover:bg-primary/80 transition-colors">
                    Guardar Dispositivo
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}


{% block page_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Llamamos a todas las funciones que 'home.html' necesita.
        initializeWaterChart();
        initializeSwitches();
        initializeTimeUpdate();
        initializeProfileApplier();
        initializeProfileModal(); 
        initializeLogoutModal(); // Esta llamada ya está en base.html
        initializeRefreshButton();
        initializeDeviceModal();
        initializeCopyButtons();
        initializeHumidityUpdater();
        initializeActivityUpdater();
        initializeDeviceSwitches();
        initializeWaterUpdater();
        // Funciones del estado.js
            initializeRefreshButton(); // <--- Para el botón de clic manual
        
        // --- ¡LÍNEA AÑADIDA! ---
        // Inicia el refresco automático cada 10 segundos (10000 ms)
        startAutomaticPolling(3000);


    });
</script>
{% endblock %}