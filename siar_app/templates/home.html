{% extends 'base.html' %}

{% block content %}

{% if is_raining %}
<div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-6 rounded-lg" role="alert">
    <div class="flex">
        <div class="py-1"><i class="ri-cloudy-2-fill text-2xl mr-3"></i></div>
        <div>
            <p class="font-bold">¡Alerta de Lluvia!</p>
            <p class="text-sm">El sistema ha detectado lluvia en su área. El riego automático y la aplicación de perfiles se han pausado temporalmente para ahorrar agua.</p>
        </div>
    </div>
</div>
{% endif %}

<div class="mb-8">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-3xl font-bold text-gray-900">Panel de Control</h2>
            <p class="text-gray-600 mt-1">Bienvenido a tu sistema de riego inteligente</p>
 
        </div>
        <div class="flex items-center space-x-3">
        <button id="btn-send-report" 
                    class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-all whitespace-nowrap !rounded-button
                           {% if not has_events %}opacity-50 cursor-not-allowed{% endif %}"
                    {% if not has_events %}disabled{% endif %}>
                <i class="ri-mail-send-line mr-2"></i>
                Enviar Reporte
        </button>
            <button id="btn-actualizar-dash" class="bg-primary text-white px-4 py-2 rounded-lg hover:opacity-90 transition-all whitespace-nowrap !rounded-button">
                <i class="ri-refresh-line mr-2"></i>Actualizar
            </button>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    
    <div id="status-sistema-card-wrapper" class="bg-white rounded-xl shadow-lg p-6 card-hover">
        {% if device_status == 'regando' %}
        <div class="flex items-center justify-between">
            <div><p class="text-sm font-medium text-gray-600">Estado del Sistema</p><p class="text-2xl font-bold text-blue-600 mt-1">Regando</p></div>
            <div class="w-12 h-12 flex items-center justify-center bg-blue-100 rounded-full status-active"><i class="ri-drop-line text-blue-600 text-2xl"></i></div>
        </div>
        {% elif device_status == 'online' %}
        <div class="flex items-center justify-between">
            <div><p class="text-sm font-medium text-gray-600">Estado del Sistema</p><p class="text-2xl font-bold text-green-600 mt-1">Conectado</p></div>
            <div class="w-12 h-12 flex items-center justify-center bg-green-100 rounded-full"><i class="ri-play-circle-fill text-green-600 text-2xl"></i></div>
        </div>
        {% else %}
        <div class="flex items-center justify-between">
            <div><p class="text-sm font-medium text-gray-600">Estado del Sistema</p><p class="text-2xl font-bold text-red-600 mt-1">Inabilitado</p></div>
            <div class="w-12 h-12 flex items-center justify-center bg-red-100 rounded-full"><i class="ri-wifi-off-line text-red-600 text-2xl"></i></div>
        </div>
        {% endif %}
    </div>
    
    <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600">Humedad del Suelo</p>
                
                <p id="humidityValue" class="text-2xl font-bold text-blue-600 mt-1">--%</p>
                
            </div>
            <div class="w-12 h-12 flex items-center justify-center bg-blue-100 rounded-full">
                <i class="ri-drop-line text-blue-600 text-2xl"></i>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
        {% if weather %}
            <div class="flex items-center justify-between">
                <div><p class="text-sm font-medium text-gray-600">{{ weather.description }}</p><p class="text-2xl font-bold text-orange-600 mt-1">{{ weather.temp }}°C</p></div>
                <div class="w-12 h-12 flex items-center justify-center bg-orange-100 rounded-full"><img src="http://openweathermap.org/img/wn/{{ weather.icon }}.png" alt="clima"></div>
            </div>
        {% else %}
            <div class="flex items-center justify-between">
                <div><p class="text-sm font-medium text-gray-600">Clima</p><p class="text-lg font-bold text-gray-500 mt-1">No disponible</p></div>
                <div class="w-12 h-12 flex items-center justify-center bg-gray-100 rounded-full"><i class="ri-question-mark text-gray-500 text-2xl"></i></div>
            </div>
        {% endif %}
    </div>
    <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Consumo de Agua</p>
                    <p id="waterConsumptionValue" class="text-2xl font-bold text-indigo-600 mt-1">--L</p>
                </div>
                <div class="w-12 h-12 flex items-center justify-center bg-indigo-100 rounded-full">
                    <i class="ri-water-percent-line text-indigo-600 text-2xl"></i>
                </div>
            </div>
        </div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
    <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6"><div class="flex items-center justify-between mb-6"><h3 class="text-xl font-semibold text-gray-900">Consumo de Agua Semanal</h3></div><div id="waterChart" class="h-80"></div></div>
<div class="bg-white rounded-xl shadow-lg p-6">
    <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-semibold text-gray-900">Mis Dispositivos</h3>
        <button id="openDeviceModal" class="text-primary hover:text-primary/80 text-sm font-medium">
            + Nuevo Dispositivo
        </button>
    </div>

    <div class="space-y-4">
        
        {% if dispositivos %}
            {% for disp in dispositivos %}
            
            {% set device_is_active = (disp.estado_actual == 'online' or disp.estado_actual == 'regando') %}
            {% set button_disabled = (is_raining or not device_is_active) %}

            <div class="p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 flex items-center justify-center bg-blue-100 rounded-lg">
                            <i class="ri-hard-drive-2-line text-blue-600"></i>
                        </div>
                        <div>
                            <p class="font-medium text-gray-900">{{ disp.nombre_dispositivo }}</p>
                            <p id="device-status-text-{{ disp.id }}" class="text-sm text-gray-600">
                                Estado: {{ disp.estado_actual }}
                            </p>
                        </div>
                    </div>
                    
                    <button class="open-apply-modal-btn text-white px-3 py-1 rounded-lg text-sm
                                 {% if button_disabled %} bg-gray-400 cursor-not-allowed opacity-70
                                 {% else %} bg-blue-500 hover:bg-blue-600 {% endif %}" 
                            data-device-id="{{ disp.id }}" 
                            data-device-name="{{ disp.nombre_dispositivo }}"
                            {% if button_disabled %}disabled{% endif %}>
                        Aplicar Perfil
                    </button>
                </div>

                {% if disp.estado_actual == 'offline_manual' or disp.estado_actual == 'offline' %}
                <div id="api-key-container-{{ disp.id }}" class="mt-4 p-3 bg-gray-200 rounded-lg flex items-center justify-between">
                    <div class="flex-1 overflow-hidden">
                        <p class="text-xs text-gray-600 font-medium">API KEY (Para el instalador):</p>
                        <p class="text-sm font-mono text-gray-800 truncate">
                            {{ disp.device_api_key }}
                        </p>
                    </div>
                    <button class="copy-api-key-btn bg-gray-600 text-white px-3 py-1 rounded-lg hover:bg-gray-700 ml-2" 
                            data-key="{{ disp.device_api_key }}">
                        <i class="ri-file-copy-line"></i>
                    </button>
                </div>
                {% endif %}
                
            </div>
            {% endfor %}
        {% else %}
            <p class="text-gray-500 text-center">No ha registrado ningún dispositivo.</p>
        {% endif %}
        
    </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    
<div id="programacion-automatica-wrapper" class="bg-white rounded-xl shadow-lg p-6">
        
        {% if configuracion_actual and configuracion_actual.perfil_activo %}
            <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                <p class="font-medium text-gray-900">Riego de Emergencia</p>
                <p class="text-sm text-gray-600">
                    Controlado por el perfil: <b class="text-primary">{{ configuracion_actual.perfil_activo.nombre_perfil }}</b>
                </p>
                <p class="text-sm text-gray-600">
                    Regar si baja de: <b>{{ configuracion_actual.perfil_activo.umbral_humedad_min }}%</b>
                </p>
                 <p class="text-sm text-gray-600">
                    No regar si supera: <b>{{ configuracion_actual.perfil_activo.umbral_humedad_max }}%</b>
                </p>
            </div>

            <div class="flex items-center justify-between p-4 border border-green-200 bg-green-50 rounded-lg mb-4">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 flex items-center justify-center bg-green-100 rounded-full">
                        <i class="ri-calendar-check-line text-green-600"></i>
                    </div>
                    {% set device_is_active = (device_status == 'online' or device_status == 'regando') %}
                    {% set switch_disabled = (is_raining or not device_is_active) %}
                    <div>
                        <p class="font-medium text-gray-900">Riego Programado (Horarios)</p>
                        <span id="modo-automatico-status">
                        {% if configuracion_actual.modo_automatico and not switch_disabled %}
                            (<b class="text-green-600">Activo</b>)
                        {% else %}
                            (<b class="text-red-600">Desactivado</b>)
                        {% endif %}
                        </span>
                    </div>
                </div>
                <div class="custom-switch 
                     {% if configuracion_actual.modo_automatico and not switch_disabled %}active{% endif %} 
                     {% if switch_disabled %}opacity-50 cursor-not-allowed{% endif %}"
                     data-config="modo_automatico" 
                     data-is-raining="{{ is_raining }}"
                     data-device-status="{{ device_status }}">
                </div>
            </div>

            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold text-gray-900">Mis Horarios</h3>
            </div>
            <div class="space-y-2">
                {% if horarios and horarios|length > 0 %}
                    {% for horario in horarios %}
                    <div class="flex items-center justify-between p-2 border-b">
                        <div class="flex items-center space-x-3">
                            <i class="ri-time-line text-gray-500"></i>
                            <div>
                                <p class="font-medium text-gray-900">{{ horario.hora_riego.strftime('%I:%M %p') }}</small>
                                <p class="text-xs text-gray-600">Perfil: <b class="text-primary">{{ horario.perfil.nombre_perfil }}</b> (Riega {{ horario.perfil.duracion_riego_seg }}s)</p>
                                <p class="text-xs text-gray-500">Días: {{ "L" if "1" in horario.dias_semana else "" }} {{ "M" if "2" in horario.dias_semana else "" }} {{ "X" if "3" in horario.dias_semana else "" }} {{ "J" if "4" in horario.dias_semana else "" }} {{ "V" if "5" in horario.dias_semana else "" }} {{ "S" if "6" in horario.dias_semana else "" }} {{ "D" if "7" in horario.dias_semana else "" }}</p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-sm text-gray-500 text-center">No hay horarios programados.</p>
                {% endif %}
            </div>

        {% else %}
            <p class="text-sm text-gray-500 text-center">
                Aún no se ha configurado un dispositivo. 
                Vaya a "Mis Dispositivos" y <b>Aplique un Perfil</b> para comenzar.
            </p>
        {% endif %}
    </div>

    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-xl font-semibold text-gray-900 mb-6">Actividad Reciente</h3>
        
        <div id="recentActivityContainer" class="space-y-4">
            </div>
        
    </div>
</div>

<div class="grid grid-cols-1 gap-8 mt-8">
<div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold text-gray-900">Perfiles de Riego</h3>
            <button id="openProfileModal" class="text-primary hover:text-primary/80 text-sm font-medium">
                + Nuevo Perfil
            </button>
        </div>
        
        <div class="space-y-4">
            {% if perfiles %}
                {% for perfil in perfiles %}
                <div class="p-4 border border-gray-200 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-lg">
                            <i class="ri-price-tag-3-line text-gray-600"></i>
                        </div>
                        
                        <div>
                            <p class="font-medium text-gray-900">{{ perfil.nombre_perfil }}</p>
                            
                            <p class="text-sm text-gray-500 italic mb-2">
                                {{ perfil.descripcion or 'Sin descripción' }}
                            </p>
                            
                            <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-sm text-gray-600">
                                
                                <span class="flex items-center" title="Umbral Mínimo (Emergencia)">
                                    <i class="ri-arrow-down-line text-red-500 mr-1"></i>
                                    <b>{{ perfil.umbral_humedad_min }}%</b>
                                </span>
                                
                                <span class="text-gray-300">|</span>
                                
                                <span class="flex items-center" title="Umbral Máximo (Ahorro)">
                                    <i class="ri-arrow-up-line text-green-500 mr-1"></i>
                                    <b>{{ perfil.umbral_humedad_max }}%</b>
                                </span>
                                
                                <span class="text-gray-300">|</span>
                                
                                <span class="flex items-center" title="Duración Riego Programado">
                                    <i class="ri-timer-line text-blue-500 mr-1"></i>
                                    <b>{{ perfil.duracion_riego_seg }}s</b>
                                </span>
                            </div>
                        </div>
                        </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-gray-500 text-center">No hay perfiles de riego creados.</p>
            {% endif %}
        </div>
    </div>
</div>
</div>
<div id="newProfileModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg mx-4">
        <div class="flex items-start justify-between mb-4">
            <h3 class="text-xl font-semibold text-gray-900">Crear Nuevo Perfil</h3>
            <button type="button" id="closeProfileModal" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
        </div>
        <form id="profileForm" class="space-y-4">
            <div>
                <label for="perfil_nombre" class="block text-sm font-medium text-gray-700">Nombre del Perfil</label>
                <input type="text" id="perfil_nombre" name="nombre_perfil" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
            </div>
            <div>
                <label for="perfil_descripcion" class="block text-sm font-medium text-gray-700">Descripción Breve</label>
                <textarea id="perfil_descripcion" name="descripcion" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label for="perfil_umbral_min" class="block text-sm font-medium text-gray-700">Umbral Mín (%)</label>
                    <input type="number" id="perfil_umbral_min" name="umbral_humedad_min" placeholder="Ej: 25" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                </div>
                <div>
                    <label for="perfil_umbral_max" class="block text-sm font-medium text-gray-700">Umbral Máx (%)</label>
                    <input type="number" id="perfil_umbral_max" name="umbral_humedad_max" placeholder="Ej: 60" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                </div>
                <div>
                    <label for="perfil_duracion" class="block text-sm font-medium text-gray-700">Duración Riego (seg)</label>
                    <input type="number" id="perfil_duracion" name="duracion_riego_seg" placeholder="Ej: 10" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                </div>
            </div>
            <div class="flex justify-end space-x-4 pt-4">
                 <button type="button" id="cancelProfileModal" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">Cancelar</button>
                 <button type="submit" class="px-5 py-2 bg-primary text-white rounded-lg hover:bg-primary/80 transition-colors">Guardar Perfil</button>
            </div>
        </form>
    </div>
</div>



<div id="newDeviceModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
        
        <div class="flex items-start justify-between mb-4">
            <h3 class="text-xl font-semibold text-gray-900">Añadir Nuevo Dispositivo</h3>
            <button id="closeDeviceModal" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
        </div>
        
        <form id="deviceForm" class="space-y-4">
            <div>
                <label for="device_nombre" class="block text-sm font-medium text-gray-700">Nombre del Dispositivo (ej: Huerto)</label>
                <input type="text" id="device_nombre" name="nombre_dispositivo" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
            </div>
            
            <div class="flex justify-end space-x-4 pt-4">
                <button type="button" id="cancelDeviceModal" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">
                    Cancelar
                </button>
                <button type="submit" class="px-5 py-2 bg-primary text-white rounded-lg hover:bg-primary/80 transition-colors">
                    Guardar Dispositivo
                </button>
            </div>
        </form>
    </div>
</div>

<div id="applyProfileToDeviceModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg mx-4">
        
        <div class="flex items-start justify-between mb-4">
            <div>
                <h3 class="text-xl font-semibold text-gray-900">Añadir Horario Programado</h3>
                <p id="modalDeviceName" class="text-gray-600"></p> 
            </div>
            <button id="closeApplyModal" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
        </div>
        
        <form id="applyProfileForm" class="space-y-4">
            <input type="hidden" id="modalDeviceId" name="device_id" value=""> 
            
            <div>
                <label for="profileSelect" class="block text-sm font-medium text-gray-700">¿Qué Perfil aplicar?</label>
                <select id="profileSelect" name="perfil_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    <option value="">Seleccione un perfil...</option>
                    {% if perfiles %}
                        {% for perfil in perfiles %}
                        <option value="{{ perfil.id }}">{{ perfil.nombre_perfil }} (Riega por {{ perfil.duracion_riego_seg }}s)</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            
            <div>
                <label for="horario_hora_modal" class="block text-sm font-medium text-gray-700">¿A qué hora?</label>
                <input type="time" id="horario_hora_modal" name="hora_riego" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">¿Qué días?</label>
                <div class="mt-2 grid grid-cols-7 gap-2 text-center">
                    {% for dia_nombre, dia_num in [('D', '7'), ('L', '1'), ('M', '2'), ('X', '3'), ('J', '4'), ('V', '5'), ('S', '6')] %}
                    <div>
                        <label for="modal_dia_{{ dia_num }}" class="block text-xs font-medium">{{ dia_nombre }}</label>
                        <input type="checkbox" id="modal_dia_{{ dia_num }}" name="dias_semana" value="{{ dia_num }}" class="mt-1 h-5 w-5 rounded">
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="flex justify-end space-x-4 pt-4">
                <button type="button" id="cancelApplyModal" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button type="submit" class="px-5 py-2 bg-primary text-white rounded-lg hover:bg-primary/80">Guardar Horario</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}


{% block page_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Llamamos a todas las funciones que 'home.html' necesita.
// Llamadas a funciones (ahora definidas en main.js)
        initializeWaterChart();
        initializeSwitches();
        initializeTimeUpdate();
        initializeAplicarPerfilModal(); // <-- Llamada única
        initializeProfileModal(); 
        initializeLogoutModal(); 
        initializeRefreshButton(); // <-- Llamada única
        initializeDeviceModal();
        initializeCopyButtons();
        initializeHumidityUpdater();
        initializeActivityUpdater();
        initializeDeviceSwitches();
        initializeWaterUpdater();
        initializeSendReportButton();
        

        
        // Inicia el refresco automático
        startAutomaticPolling(3000);

        



    });
</script>
{% endblock %}